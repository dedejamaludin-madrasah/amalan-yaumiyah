<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Amalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 pb-20">

    <div class="bg-green-600 p-4 text-white flex justify-between items-center shadow">
        <div>
            <h1 class="font-bold text-lg">Input Harian</h1>
            <p class="text-xs opacity-80" id="currentDate">-</p>
        </div>
        <button onclick="logout()" class="text-xs bg-green-800 px-3 py-1 rounded">Keluar</button>
    </div>

    <div id="loading" class="text-center p-10 text-gray-500">Memuat data...</div>
    <div id="content" class="p-4 space-y-4 hidden">
        
        <div id="cardList"></div>

    </div>

    <div class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 text-gray-500 text-xs shadow-inner">
        <a href="dashboard.html" class="flex flex-col items-center text-green-600">
            <i class="fa-solid fa-house mb-1 text-lg"></i> Input
        </a>
        <a href="rekap.html" class="flex flex-col items-center hover:text-green-600">
            <i class="fa-solid fa-list mb-1 text-lg"></i> Rekap
        </a>
    </div>

    <script src="config.js"></script>
    <script>
        let currentUser = null;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('id-ID', { weekday:'long', dateStyle:'medium'});

        // Definisi Amalan
        const amalanConfig = [
            { key: 'shalat_jamaah', title: 'Shalat Jamaah', label: 'Max 5', type: 'counter', max: 5 },
            { key: 'shalat_rawatib', title: 'Rawatib', label: 'Max 12 Rakaat', type: 'counter', max: 12 },
            { key: 'shalat_dhuha', title: 'Dhuha', label: 'Min 2 Rakaat', type: 'counter', max: 12 },
            { key: 'tilawah_juz', title: 'Tilawah (Juz)', label: 'Target 1 Juz', type: 'counter', max: 30 },
            { key: 'infaq', title: 'Infaq Harian', label: 'Sudah Infaq?', type: 'check' },
            { key: 'olahraga', title: 'Olahraga', label: 'Sudah Olahraga?', type: 'check' }
        ];

        let amalanData = {};

        // 1. Cek Login & Load Data
        checkSession().then(user => {
            currentUser = user;
            loadData();
        });

        async function loadData() {
            // Ambil data hari ini
            const { data, error } = await db
                .from('daily_amalan')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', today)
                .single();

            // Jika data ada pakai data db, jika tidak pakai default kosong
            amalanData = data || { user_id: currentUser.id, date: today };
            
            renderCards();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        // 2. Render UI
        function renderCards() {
            const container = document.getElementById('cardList');
            container.innerHTML = '';

            amalanConfig.forEach(item => {
                const val = amalanData[item.key] || 0;
                
                let inputEl = '';
                if(item.type === 'counter') {
                    inputEl = `
                    <div class="flex items-center gap-3">
                        <button onclick="update('${item.key}', ${val - 1})" class="w-8 h-8 rounded-full bg-gray-200 font-bold">-</button>
                        <span class="w-6 text-center font-bold">${val}</span>
                        <button onclick="update('${item.key}', ${val + 1}, ${item.max})" class="w-8 h-8 rounded-full bg-green-100 text-green-700 font-bold">+</button>
                    </div>`;
                } else {
                    inputEl = `
                    <input type="checkbox" onchange="update('${item.key}', this.checked)" 
                    ${val ? 'checked' : ''} class="w-6 h-6 accent-green-600">`;
                }

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow border flex justify-between items-center";
                card.innerHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-800">${item.title}</h3>
                        <p class="text-xs text-gray-500">${item.label}</p>
                    </div>
                    ${inputEl}
                `;
                container.appendChild(card);
            });
        }

        // 3. Update & Save Logic
        async function update(key, value, max) {
            if (typeof value === 'number') {
                if (value < 0) return;
                if (max && value > max) return;
            }

            // Update state lokal
            amalanData[key] = value;
            renderCards(); // Refresh UI instant

            // Simpan ke DB (Upsert)
            const payload = {
                user_id: currentUser.id,
                date: today,
                [key]: value
            };

            await db.from('daily_amalan').upsert(payload, { onConflict: 'user_id, date' });
        }

        async function logout() {
            await db.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>