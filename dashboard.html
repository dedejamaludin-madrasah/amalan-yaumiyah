<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Input Amalan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; padding-bottom: 100px; }
        /* Custom Date Picker Style */
        input[type="date"] {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }
        /* Icon kalender di date picker agar putih */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="fixed top-0 left-0 w-full bg-emerald-600 text-white z-50 shadow-md rounded-b-3xl">
        <div class="px-6 pt-6 pb-2 flex justify-between items-center">
            <div>
                <p class="text-emerald-100 text-xs mb-1">Assalamu'alaikum,</p>
                <h2 id="userNameDisplay" class="font-bold text-xl leading-none">Pegawai</h2>
            </div>
            <button onclick="logout()" class="bg-emerald-800 p-2 rounded-full text-xs hover:bg-emerald-900 transition">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </div>
        
        <div class="px-6 pb-4 flex justify-between items-center">
            <span class="text-xs text-emerald-100">Pilih Tanggal:</span>
            <input type="date" id="datePicker">
        </div>
    </div>

    <div class="h-36"></div>

    <div class="px-4 max-w-md mx-auto">
        <div id="loading" class="text-center py-10 text-gray-400">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><br>Mengambil data...
        </div>
        
        <div id="cardContainer" class="space-y-4 hidden">
            </div>
    </div>

    <div class="fixed bottom-4 left-4 right-4 bg-white rounded-2xl shadow-2xl flex justify-between px-6 py-3 border border-gray-100 max-w-md mx-auto z-50">
        <a href="dashboard.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Input</span>
        </a>
        <a href="rekap.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Jurnal</span>
        </a>
        <a href="stats.html" class="flex flex-col items-center text-emerald-600">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Statistik</span>
        </a>
    </div>

    <script src="config.js"></script>
    <script>
        const user = getSession();
        if(!user) window.location.href = 'index.html';

        document.getElementById('userNameDisplay').innerText = user.full_name || user.username;
        
        // Setup Tanggal Hari Ini
        const todayStr = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('datePicker');
        dateInput.value = todayStr;

        // Event: Ganti Tanggal
        dateInput.addEventListener('change', (e) => {
            init(e.target.value);
        });

        // Konfigurasi Item Baru
        const items = [
            { key: 'shalat_jamaah', title: 'Shalat Jamaah', icon: 'fa-mosque', type: 'count', max: 5, label: 'Max 5' },
            { key: 'shalat_rawatib', title: 'Shalat Rawatib', icon: 'fa-person-praying', type: 'count', max: 12, label: 'Max 12 Rakaat' },
            { key: 'shalat_tahajjud', title: 'Tahajjud', icon: 'fa-moon', type: 'count', max: 11, label: 'Min 2 Rakaat' },
            { key: 'shalat_dhuha', title: 'Dhuha', icon: 'fa-sun', type: 'count', max: 8, label: 'Min 2 Rakaat' },
            { key: 'tilawah_juz', title: 'Tilawah (Juz)', icon: 'fa-book-quran', type: 'count', max: 30, label: 'Min 1 Juz' },
            { key: 'matsurat', title: 'Matsurat', icon: 'fa-book-open-reader', type: 'count', max: 2, label: 'Min 1x' },
            { key: 'shaum_sunnah', title: 'Puasa Sunnah', icon: 'fa-utensils', type: 'check', label: 'Sedang puasa?' },
            { key: 'infaq', title: 'Infaq', icon: 'fa-hand-holding-dollar', type: 'check', label: 'Sudah Infaq?' },
            { key: 'olahraga', title: 'Olahraga', icon: 'fa-person-running', type: 'check', label: 'Sudah Olahraga?' },
        ];

        let currentData = {};

        async function init(selectedDate) {
            // Tampilkan loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('cardContainer').classList.add('hidden');

            // Ambil data dari DB berdasarkan tanggal yang dipilih
            const { data } = await db.from('daily_amalan')
                .select('*')
                .eq('user_id', user.id)
                .eq('date', selectedDate)
                .single();
            
            currentData = data || { user_id: user.id, date: selectedDate };
            
            renderUI();
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('cardContainer').classList.remove('hidden');
        }

        function renderUI() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            items.forEach(item => {
                const val = currentData[item.key] || 0;
                let controlHTML = '';

                if(item.type === 'count') {
                    controlHTML = `
                        <div class="flex items-center bg-gray-100 rounded-lg p-1">
                            <button onclick="update('${item.key}', ${val - 1})" class="w-8 h-8 flex items-center justify-center bg-white rounded text-red-500 shadow-sm hover:bg-red-50 font-bold disabled:opacity-50" ${val <= 0 ? 'disabled' : ''}>-</button>
                            <span class="w-8 text-center font-bold text-gray-700">${val}</span>
                            <button onclick="update('${item.key}', ${val + 1}, ${item.max})" class="w-8 h-8 flex items-center justify-center bg-white rounded text-emerald-600 shadow-sm hover:bg-emerald-50 font-bold disabled:opacity-50" ${val >= item.max ? 'disabled' : ''}>+</button>
                        </div>
                    `;
                } else {
                    controlHTML = `
                        <button onclick="update('${item.key}', ${!val})" class="w-10 h-10 rounded-lg flex items-center justify-center border-2 transition ${val ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-300 text-gray-300'}">
                            <i class="fa-solid fa-check text-lg"></i>
                        </button>
                    `;
                }

                const cardHtml = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between transition active:scale-95">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                                <i class="fa-solid ${item.icon}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">${item.title}</h4>
                                <p class="text-[10px] text-gray-400">${item.label}</p>
                            </div>
                        </div>
                        ${controlHTML}
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        async function update(key, val, max) {
            if (typeof val === 'number') {
                if (val < 0) return;
                if (max && val > max) return;
            }
            
            // Update UI instant
            currentData[key] = val;
            renderUI();

            // Save DB dengan tanggal yang sedang dipilih
            const dateVal = document.getElementById('datePicker').value;
            const payload = { user_id: user.id, date: dateVal, [key]: val };
            
            await db.from('daily_amalan').upsert(payload, { onConflict: 'user_id, date' });
        }

        // Load awal
        init(todayStr);
    </script>
</body>

</html>
