<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Statistik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body { background-color: #f8fafc; padding-bottom: 100px; }</style>
</head>
<body>

    <div class="bg-emerald-600 text-white p-6 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-40">
        <h1 class="font-bold text-2xl">Capaian Amalan</h1>
        
        <div class="flex gap-4 text-xs text-emerald-100 mt-2 mb-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-white rounded opacity-90"></div> 
                <span class="font-medium">Saya</span> </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-emerald-800 rounded border border-emerald-600"></div> 
                <span class="font-medium">Rata-rata Pegawai</span>
            </div>
        </div>

        <div class="flex bg-emerald-800/30 p-1 rounded-lg backdrop-blur-sm">
            <button onclick="switchMode('today')" id="btnToday" class="flex-1 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-emerald-700">Hari Ini</button>
            <button onclick="switchMode('month')" id="btnMonth" class="flex-1 py-1.5 rounded-md text-xs font-bold transition text-emerald-100 hover:text-white">Bulan Ini</button>
        </div>
    </div>

    <div id="statsContainer" class="px-4 max-w-md mx-auto space-y-4">
        <p class="text-center text-gray-400 mt-10"><i class="fa-solid fa-circle-notch fa-spin"></i> Menghitung data...</p>
    </div>

    <div class="fixed bottom-4 left-4 right-4 bg-white rounded-2xl shadow-2xl flex justify-between px-6 py-3 border border-gray-100 max-w-md mx-auto z-50">
        <a href="dashboard.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Input</span>
        </a>
        <a href="rekap.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Jurnal</span>
        </a>
        <a href="stats.html" class="flex flex-col items-center text-emerald-600">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Statistik</span>
        </a>
    </div>

    <script src="config.js"></script>
    <script>
        const user = getSession();
        if(!user) window.location.href = 'index.html';

        const CONFIG = [
            { key: 'shalat_jamaah', label: 'Shalat Jamaah', target: 5 },
            { key: 'shalat_rawatib', label: 'Rawatib', target: 12 },
            { key: 'shalat_tahajjud', label: 'Tahajjud', target: 2 },
            { key: 'shalat_dhuha', label: 'Dhuha', target: 2 },
            { key: 'tilawah_juz', label: 'Tilawah Quran', target: 1 },
            { key: 'matsurat', label: 'Matsurat', target: 1 },
            { key: 'shaum_sunnah', label: 'Puasa Sunnah', target: true },
            { key: 'infaq', label: 'Infaq', target: true },
            { key: 'olahraga', label: 'Olahraga', target: true }
        ];

        let mode = 'today'; 

        async function loadStats() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '<p class="text-center text-gray-400 mt-10"><i class="fa-solid fa-circle-notch fa-spin"></i> Menghitung data...</p>';

            const { count: totalUsers } = await db.from('users').select('*', { count: 'exact', head: true });
            if(!totalUsers) { container.innerHTML = 'Error data user.'; return; }

            const today = new Date();
            let dateFilter = {};
            let dividerDays = 1;

            if(mode === 'today') {
                const dateStr = today.toISOString().split('T')[0];
                dateFilter = { op: 'eq', val: dateStr };
                dividerDays = 1;
            } else {
                const y = today.getFullYear();
                const m = today.getMonth(); 
                const start = new Date(y, m, 1).toISOString().split('T')[0];
                const end = new Date(y, m + 1, 0).toISOString().split('T')[0];
                dividerDays = today.getDate();
                dateFilter = { op: 'range', val: start, val2: end };
            }

            let qMy = db.from('daily_amalan').select('*').eq('user_id', user.id);
            let qAll = db.from('daily_amalan').select('*');

            if(mode === 'today') {
                qMy = qMy.eq('date', dateFilter.val);
                qAll = qAll.eq('date', dateFilter.val);
            } else {
                qMy = qMy.gte('date', dateFilter.val).lte('date', dateFilter.val2);
                qAll = qAll.gte('date', dateFilter.val).lte('date', dateFilter.val2);
            }
            
            const { data: myData } = await qMy;
            const { data: allData } = await qAll;

            renderComparison(myData || [], allData || [], totalUsers, dividerDays);
        }

        function renderComparison(myData, allData, totalUsers, daysPassed) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';

            CONFIG.forEach(item => {
                let mySuccess = 0;
                myData.forEach(row => {
                    const val = row[item.key];
                    if(item.target === true) { if(val) mySuccess++; }
                    else { if(val >= item.target) mySuccess++; }
                });
                const myPercent = Math.round((mySuccess / daysPassed) * 100);

                let globalSuccess = 0;
                allData.forEach(row => {
                    const val = row[item.key];
                    if(item.target === true) { if(val) globalSuccess++; }
                    else { if(val >= item.target) globalSuccess++; }
                });
                const globalPercent = Math.round((globalSuccess / (totalUsers * daysPassed)) * 100);

                // Warna Diagram: Saya (Putih/Emerald) vs Rata-rata (Gelap/Abu)
                // Disini saya sesuaikan agar match dengan legenda di header
                const html = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="font-bold text-gray-700 text-sm">${item.label}</h3>
                        </div>
                        
                        <div class="relative w-full bg-emerald-100 rounded-md h-5 mb-2 overflow-hidden">
                            <div class="bg-emerald-500 h-full rounded-md flex items-center justify-end pr-2 transition-all duration-1000" style="width: ${Math.max(myPercent, 5)}%">
                                <span class="text-[10px] text-white font-bold">${myPercent}%</span>
                            </div>
                        </div>

                        <div class="relative w-full bg-gray-100 rounded-md h-5 overflow-hidden">
                            <div class="bg-gray-500 h-full rounded-md flex items-center justify-end pr-2 transition-all duration-1000" style="width: ${Math.max(globalPercent, 5)}%">
                                <span class="text-[10px] text-white font-bold">${globalPercent}%</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function switchMode(m) {
            mode = m;
            const activeClass = "flex-1 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-emerald-700";
            const inactiveClass = "flex-1 py-1.5 rounded-md text-xs font-bold transition text-emerald-100 hover:text-white";

            document.getElementById('btnToday').className = m === 'today' ? activeClass : inactiveClass;
            document.getElementById('btnMonth').className = m === 'month' ? activeClass : inactiveClass;
            loadStats();
        }

        loadStats();
    </script>
</body>
</html>