<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Statistik Perbandingan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>body { background-color: #f8fafc; padding-bottom: 100px; }</style>
</head>
<body>

    <div class="bg-white p-6 rounded-b-3xl shadow-sm mb-4">
        <h1 class="font-bold text-2xl text-gray-800">Capaian Amalan</h1>
        <p class="text-gray-500 text-xs">Bandingkan keistiqomahanmu dengan rata-rata kantor</p>
        
        <div class="flex bg-gray-100 rounded-lg p-1 mt-4">
            <button onclick="switchMode('today')" id="btnToday" class="flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-emerald-600 transition">Hari Ini</button>
            <button onclick="switchMode('month')" id="btnMonth" class="flex-1 py-1 rounded-md text-sm font-bold text-gray-500 transition">Bulan Ini</button>
        </div>
    </div>

    <div id="statsContainer" class="px-4 max-w-md mx-auto space-y-5">
        <p class="text-center text-gray-400 mt-10"><i class="fa-solid fa-circle-notch fa-spin"></i> Menghitung data...</p>
    </div>

    <div class="px-4 mt-4 mb-2 flex justify-center gap-6 text-[10px] text-gray-400">
        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-emerald-500 rounded"></div> Saya</div>
        <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-300 rounded"></div> Rata-rata Kantor</div>
    </div>

    <div class="fixed bottom-4 left-4 right-4 bg-white rounded-2xl shadow-2xl flex justify-between px-6 py-3 border border-gray-100 max-w-md mx-auto z-50">
        <a href="dashboard.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-pen-to-square text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Input</span>
        </a>
        <a href="rekap.html" class="flex flex-col items-center text-gray-400 hover:text-emerald-600">
            <i class="fa-solid fa-list-check text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Jurnal</span>
        </a>
        <a href="stats.html" class="flex flex-col items-center text-emerald-600">
            <i class="fa-solid fa-chart-pie text-xl mb-1"></i>
            <span class="text-[10px] font-bold">Statistik</span>
        </a>
    </div>

    <script src="config.js"></script>
    <script>
        const user = getSession();
        if(!user) window.location.href = 'index.html';

        // Konfigurasi Target
        const CONFIG = [
            { key: 'shalat_jamaah', label: 'Shalat Jamaah (5x)', target: 5 },
            { key: 'shalat_rawatib', label: 'Rawatib (Min 10 Rkt)', target: 10 }, // Asumsi target moderat
            { key: 'shalat_tahajjud', label: 'Tahajjud (Min 2 Rkt)', target: 2 },
            { key: 'tilawah_juz', label: 'Tilawah (1 Juz)', target: 1 },
            { key: 'matsurat', label: 'Matsurat', target: 1 },
            { key: 'shaum_sunnah', label: 'Puasa Sunnah', target: true },
            { key: 'infaq', label: 'Infaq', target: true }
        ];

        let mode = 'today'; 

        async function loadStats() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '<p class="text-center text-gray-400 mt-10"><i class="fa-solid fa-circle-notch fa-spin"></i> Menghitung data...</p>';

            // 1. Ambil Total Pegawai (Untuk pembagi)
            const { count: totalUsers } = await db.from('users').select('*', { count: 'exact', head: true });
            if(!totalUsers) { container.innerHTML = 'Error data user.'; return; }

            // 2. Siapkan Range Tanggal
            const today = new Date();
            let dateFilter = {};
            let dividerDays = 1;

            if(mode === 'today') {
                const dateStr = today.toISOString().split('T')[0];
                dateFilter = { column: 'date', op: 'eq', val: dateStr };
                dividerDays = 1;
            } else {
                // Bulan ini (dari tanggal 1 sampai hari ini)
                const y = today.getFullYear();
                const m = today.getMonth(); 
                const start = new Date(y, m, 1).toISOString().split('T')[0];
                const end = new Date(y, m + 1, 0).toISOString().split('T')[0]; // Sampai akhir bulan
                
                // Pembagi persentase bulanan adalah jumlah hari yang sudah berlalu
                dividerDays = today.getDate(); 

                dateFilter = { column: 'date', op: 'gte', val: start, val2: end };
            }

            // 3. Ambil Data
            // Query 1: Data SAYA saja
            let qMy = db.from('daily_amalan').select('*').eq('user_id', user.id);
            if(mode==='today') qMy = qMy.eq('date', dateFilter.val);
            else qMy = qMy.gte('date', dateFilter.val).lte('date', dateFilter.val2);
            
            const { data: myData } = await qMy;

            // Query 2: Data SEMUA ORANG (Global)
            let qAll = db.from('daily_amalan').select('*');
            if(mode==='today') qAll = qAll.eq('date', dateFilter.val);
            else qAll = qAll.gte('date', dateFilter.val).lte('date', dateFilter.val2);

            const { data: allData } = await qAll;

            // 4. Hitung Persentase
            renderComparison(myData || [], allData || [], totalUsers, dividerDays);
        }

        function renderComparison(myData, allData, totalUsers, daysPassed) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';

            CONFIG.forEach(item => {
                // A. Hitung Score SAYA (%)
                // Rumus: (Jumlah hari berhasil target / Hari berlalu) * 100
                let mySuccessCount = 0;
                myData.forEach(row => {
                    const val = row[item.key];
                    if(item.target === true) { if(val) mySuccessCount++; }
                    else { if(val >= item.target) mySuccessCount++; }
                });
                
                // Jika mode 'today', daysPassed = 1. Jadi kalau sukses = 100%, gagal = 0%.
                const myPercent = Math.round((mySuccessCount / daysPassed) * 100);


                // B. Hitung Score KANTOR (%)
                // Rumus: (Total semua keberhasilan pegawai / (Total Pegawai * Hari berlalu)) * 100
                let globalSuccessCount = 0;
                allData.forEach(row => {
                    const val = row[item.key];
                    if(item.target === true) { if(val) globalSuccessCount++; }
                    else { if(val >= item.target) globalSuccessCount++; }
                });

                const globalTotalOpportunities = totalUsers * daysPassed;
                const globalPercent = Math.round((globalSuccessCount / globalTotalOpportunities) * 100);

                // Render Kartu
                const html = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-700 text-sm">${item.label}</h3>
                        </div>
                        
                        <div class="mb-2">
                            <div class="flex justify-between text-[10px] mb-1">
                                <span class="text-emerald-600 font-bold">Saya</span>
                                <span class="text-emerald-600 font-bold">${myPercent}%</span>
                            </div>
                            <div class="w-full bg-emerald-100 rounded-full h-2">
                                <div class="bg-emerald-500 h-2 rounded-full transition-all duration-1000" style="width: ${myPercent}%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-[10px] mb-1">
                                <span class="text-gray-400">Rata-rata Kantor</span>
                                <span class="text-gray-500">${globalPercent}%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                <div class="bg-gray-400 h-2 rounded-full transition-all duration-1000" style="width: ${globalPercent}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function switchMode(m) {
            mode = m;
            document.getElementById('btnToday').className = m === 'today' ? "flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-emerald-600 transition" : "flex-1 py-1 rounded-md text-sm font-bold text-gray-500 transition";
            document.getElementById('btnMonth').className = m === 'month' ? "flex-1 py-1 rounded-md text-sm font-bold bg-white shadow text-emerald-600 transition" : "flex-1 py-1 rounded-md text-sm font-bold text-gray-500 transition";
            loadStats();
        }

        loadStats();
    </script>
</body>
</html>